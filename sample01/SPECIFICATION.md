# sample01: 次世代銀行システム サンプル仕様書

## 1. 概要

本ドキュメントは、ドメイン駆動設計（DDD）の原則に基づき開発されるサンプル銀行システム「sample01」の仕様を定義する。
このシステムは、口座管理や振込といった基本的な銀行業務機能を通じて、クリーンアーキテクチャ、Sagaパターン、モダンなテスト戦略などのベストプラクティスを具体的に示すことを目的とする。

## 2. システムアーキテクチャ

- **基本アーキテクチャ**: クリーンアーキテクチャ（オニオンアーキテクチャ）を採用し、ビジネスロジック（ドメイン層）を技術的詳細から完全に分離する。
- **ドメイン分割**: システムは以下の「境界づけられたコンテキスト」に分割される。
  - **口座管理コンテキスト**: 口座のライフサイクルと残高を管理する。
  - **振込コンテキスト**: 口座間の資金移動プロセスを管理する。
- **技術スタック**:
  - 言語: Java 17
  - フレームワーク: Spring Boot 3
  - 永続化: MyBatis 3
  - テスト: Spock, Testcontainers
  - データベース: PostgreSQL

## 3. 機能仕様

### 3.1. 口座管理コンテキスト

#### 3.1.1. 口座開設

- **機能**: 新規に銀行口座を開設する。
- **入力**:
  - 顧客名
  - 初期預金額
- **処理**:
  1. ユニークな口座番号を採番する。
  2. 口座アグリゲートを生成し、状態を「開設済み(ACTIVE)」とする。
  3. 初期預金額を残高に設定する。
- **出力**: 開設された口座の情報（口座ID、口座番号など）。

#### 3.1.2. 入金

- **機能**: 指定された口座に入金する。
- **入力**:
  - 口座ID
  - 入金額
- **処理**:
  1. 指定された口座IDの口座アグリゲートを読み込む。
  2. 残高に入金額を加算する。
- **ビジネスルール**:
  - 入金額は0より大きい値でなければならない。

#### 3.1.3. 出金

- **機能**: 指定された口座から出金する。
- **入力**:
  - 口座ID
  - 出金額
- **処理**:
  1. 指定された口座IDの口座アグリゲートを読み込む。
  2. 残高から出金額を減算する。
- **ビジネスルール**:
  - 出金額は0より大きい値でなければならない。
  - **出金後の残高は0円を下回ってはならない。**

#### 3.1.4. 口座情報照会

- **機能**: 指定された口座の現在の情報を取得する。
- **入力**: 口座ID
- **出力**:
  - 口座ID
  - 口座番号
  - 顧客名
  - 現在の残高

### 3.2. 振込コンテキスト

#### 3.2.1. 振込依頼

- **機能**: ある口座から別の口座への資金移動（振込）を依頼する。
- **入力**:
  - 出金元口座ID
  - 入金先口座ID
  - 振込金額
- **処理**:
  - この操作は複数の口座（アグリゲート）にまたがるため、**Sagaパターン**を用いて結果整合性を保証する。
  - 振込依頼アグリゲートを生成し、状態を「依頼中(REQUESTED)」とする。
  - `TransferRequested`ドメインイベントを発行し、非同期のSagaプロセスを開始する。
- **Sagaプロセス**:
  1. **出金処理**: 出金元口座から指定金額を出金する。
     - **成功**: 次の入金処理へ進む。
     - **失敗 (残高不足など)**: 振込依頼の状態を「失敗(FAILED)」とし、プロセスを終了する。
  2. **入金処理**: 入金先口座に指定金額を入金する。
     - **成功**: 振込依頼の状態を「完了(COMPLETED)」とし、プロセスを終了する。
     - **失敗 (口座不存在など)**: **補償トランザクション**として、先ほどの出金処理を取り消す（同額を入金し直す）。振込依頼の状態を「失敗(FAILED)」とし、プロセスを終了する。

## 4. 非機能要件

- **同時実行制御**: 複数の操作が同時に行われた際のデータ不整合を防ぐため、`Account`アグリゲートの永続化には**楽観的ロック**を用いる。
- **信頼性**: サービス障害時にもデータの一貫性が保たれるよう、Sagaパターンと補償トランザクションを実装する。
- **テスト**: ドメインロジック、永続化、APIエンドポイントまで、各層に応じたテストを記述し、システムの品質を保証する。

## 5. APIエンドポイント概要

- `POST /api/accounts`: 口座開設
- `GET /api/accounts/{accountId}`: 口座情報照会
- `POST /api/accounts/{accountId}/deposits`: 入金
- `POST /api/accounts/{accountId}/withdrawals`: 出金
- `POST /api/transfers`: 振込依頼 